# Copyright 2008 Red Hat, Inc. and/or its affiliates.
#
# Licensed to you under the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.  See the files README and
# LICENSE_GPL_v2 which accompany this distribution.
#
SUBDIRS=vdsm_cli re vds_bootstrap vdsm vdsm_reg vdsm_hooks
DOCS=COPYING README

all: rpm

rpmversion=@PACKAGE_VERSION@
rpmrelease=@PACKAGE_RELEASE@
RPMTOP=$(PWD)/rpmtop
SPEC=vdsm.spec

TARBALL=vdsm-$(rpmversion)-$(rpmrelease).tar.gz
SRPM=$(RPMTOP)/SRPMS/vdsm-$(rpmversion)-$(rpmrelease).src.rpm

TESTS=pyflakes

test: pyflakes exceptions
	echo $(rpmrelease) $(rpmversion)

exceptions:
	python vdsm/storage/storage_exception.py | grep Collision && exit 1 || true

pyflakes:
	@git ls-files '*.py' | xargs pyflakes \
	    || (echo "Pyflakes errors or pyflakes not found"; exit 1)

install:
	for subdir in $(SUBDIRS); do make -C $$subdir $@; done

.PHONY: tarball
tarball: $(TARBALL)
$(TARBALL): Makefile $(SUBDIRS) $(DOCS) $(TESTS)
	tar zcf $(TARBALL) `git ls-files | grep -v /ut/` vdsm.spec configure

.PHONY: srpm rpm
srpm: $(SRPM)
$(SRPM): $(TARBALL) vdsm.spec.in
	mkdir -p $(RPMTOP)/{RPMS,SRPMS,SOURCES,BUILD}
	rpmbuild -ts \
	    --define="_topdir $(RPMTOP)" \
	    --define="_sourcedir $(PWD)" $(TARBALL)

rpm: $(SRPM)
	rpmbuild --define="_topdir $(RPMTOP)" -ta $(TARBALL)

clean:
	$(RM) *~ *.pyc vdsm*.tar.gz $(SPEC)
	$(RM) -r rpmtop
