# Copyright 2008 Red Hat, Inc. and/or its affiliates.
#
# Licensed to you under the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.  See the files README and
# LICENSE_GPL_v2 which accompany this distribution.
#

INSTALL=install

FILES=define.py utils.py constants.py \
      vm.py libvirtvm.py libvirtev.py \
      caps.py clientIF.py hooks.py hooking.py \
      guestIF.py dsaversion.py \
      configNetwork.py SecureXMLRPCServer.py ksm.py \
      netinfo.py neterrors.py \
      kaxmlrpclib.py config.py logUtils.py \
      supervdsm.py supervdsmServer.py \
      libvirtconnection.py vdsmDebugPlugin.py \
      pthread.py betterThreading.py \

SCRIPTFILES=vdsm logCollector.sh \
            addNetwork delNetwork \
            get-conf-item set-conf-item \
            mk_sysprep_floppy \
            write-net-config vdsm-restore-net-config \
            vdsm-store-net-config \
            get-vm-pid respawn \
            prepare-vmchannel

STORAGEFILES=storageConstants.py dispatcher.py storage_exception.py \
             __init__.py \
             sd.py sp.py blockSD.py fileSD.py hsm.py safelease.py spm.py \
             image.py volume.py blockVolume.py fileVolume.py taskManager.py\
             resourceManager.py storage_connection.py fileUtils.py misc.py hba.py \
             lvm.py iscsi.py multipath.py threadPool.py task.py \
             storage_mailbox.py sdc.py sdf.py persistentDict.py \
             threadLocal.py nfsSD.py localFsSD.py resourceFactories.py \
	     outOfProcess.py processPool.py devicemapper.py

FILES_SUBSTITUTIONS = \
	constants.py \
	vdsm-sosplugin.py \
	sudoers.vdsm \
	logger.conf \
	vdsmd \
	vdsm-store-net-config \
	vdsm-restore-net-config

PROTECTFILES=spmprotect.sh spmstop.sh safelease

prefix = @prefix@
exec_prefix = @exec_prefix@
VDSMDIR = @datarootdir@/vdsm
VDSMLOGDIR = @localstatedir@/log/vdsm
VDSMRUNDIR = @localstatedir@/run/vdsm
VDSMLIBDIR = @localstatedir@/lib/vdsm
LOGROTATEDIR = @sysconfdir@/logrotate.d
SOSPLUGINDIR = @libdir@/python/site-packages/sos/plugins
POOLSDATADIR = $(VDSMRUNDIR)/pools
BACKUPDIR = $(VDSMLOGDIR)/backup
LIBEXECDIR = @libexecdir@/vdsm
HOOKSDIR = $(LIBEXECDIR)/hooks
CONFDIR = $(VDSMDIR)
TRUSTSTORE = $(VDSMRUNDIR)/ts
MANDIR = @mandir@
UDEVDIR = @sysconfdir@/udev/rules.d

CFLAGS=-Wall -O

all: storage/protect/safelease

vdsm.conf.sample: config.py
	python mk_vdsm.conf.sample.py > vdsm.conf.sample

# Reference:
# http://www.gnu.org/software/automake/manual/html_node/Scripts.html#Scripts
do_subst = sed -e "s,[@]CONFDIR[@],$(CONFDIR),g" \
	    -e "s,[@]VDSMLOGDIR[@],$(VDSMLOGDIR),g" \
	    -e "s,[@]VDSMDIR[@],$(VDSMDIR),g" \
	    -e "s,[@]HOOKSDIR[@],$(HOOKSDIR),g" \
	    -e "s,[@]VDSMRUNDIR[@],$(VDSMRUNDIR),g" \
	    -e "s,[@]VDSMLIBDIR[@],$(VDSMLIBDIR),g" \
	    -e "s,[@]POOLSDIR[@],$(POOLSDATADIR),g" \
	    -e "s,[@]BACKUPDIR[@],$(BACKUPDIR),g" \
	    -e "s,[@]LIBEXECDIR[@],$(LIBEXECDIR),g" \
	    -e "s,[@]TRUSTSTORE[@],$(TRUSTSTORE),g"

$(FILES_SUBSTITUTIONS):
	$(do_subst) < $@.in > $@

install: $(FILES_SUBSTITUTIONS) vdsm.conf.sample
	$(INSTALL) -Dd $(DESTDIR)$(VDSMDIR)/storage/protect
	$(INSTALL) -Dd $(DESTDIR)$(TRUSTSTORE)/{certs,keys}
	$(INSTALL) -Dd $(DESTDIR)$(VDSMLOGDIR)
	$(INSTALL) -Dd $(DESTDIR)$(VDSMRUNDIR)
	$(INSTALL) -Dd $(DESTDIR)$(VDSMLIBDIR)/netconfback
	$(INSTALL) -Dd $(DESTDIR)$(POOLSDATADIR)
	$(INSTALL) -Dd $(DESTDIR)$(BACKUPDIR)
	$(INSTALL) -Dd $(DESTDIR)$(POOLDATADIR)
	$(INSTALL) -Dd $(DESTDIR)$(LIBEXECDIR)
	$(INSTALL) -Dd $(DESTDIR)/etc/init.d
	$(INSTALL) -Dd $(DESTDIR)/etc/udev/rules.d
	$(INSTALL) -Dd -m 775 $(DESTDIR)/var/lib/libvirt/qemu/channels
	$(INSTALL) -Dm 644 $(FILES) $(DESTDIR)$(VDSMDIR)
	$(INSTALL) -Dm 755 $(SCRIPTFILES) $(DESTDIR)$(VDSMDIR)
	(cd storage; \
	    $(INSTALL) -Dm 644 $(STORAGEFILES) $(DESTDIR)$(VDSMDIR)/storage)
	(cd storage/protect; \
	    $(INSTALL) -Dm 755 $(PROTECTFILES) $(DESTDIR)$(LIBEXECDIR))
	$(INSTALL) -Dm 644 storage/12-vdsm-lvm.rules $(DESTDIR)$(UDEVDIR)
	$(INSTALL) -Dm 644 logger.conf $(DESTDIR)$(CONFDIR)/logger.conf
	$(INSTALL) -Dm 755 vdsmd $(DESTDIR)/etc/init.d/vdsmd
	$(INSTALL) -Dm 440 sudoers.vdsm $(DESTDIR)/etc/sudoers.d/50_vdsm
	$(INSTALL) -Dm 644 vdsm-logrotate.conf $(DESTDIR)/etc/logrotate.d/vdsm
	$(INSTALL) -Dm 755 vdsm-logrotate $(DESTDIR)/etc/cron.hourly/vdsm-logrotate
	$(INSTALL) -Dm 755 vdsm-libvirt-logrotate $(DESTDIR)/etc/cron.d/vdsm-libvirt-logrotate
	$(INSTALL) -Dm 644 vdsm-sosplugin.py $(DESTDIR)$(SOSPLUGINDIR)/vdsm.py
	$(INSTALL) -Dm 644 vdsmd.8 $(DESTDIR)$(MANDIR)/man8/vdsmd.8
	$(INSTALL) -Dm 644 vdsm.rwtab $(DESTDIR)/etc/rwtab.d/vdsm

clean:
	$(RM) *~ *.pyc storage/protect/safelease vdsm.conf.sample
